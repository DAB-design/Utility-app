import streamlit as st
import pytesseract
from PIL import Image
import pandas as pd
import os
from datetime import datetime

# --- CONFIGURATION ---
# Note: When you deploy this to the web later, this path handling changes slightly.
# For local testing on Windows, you usually need to point to the installed .exe
# pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

DATA_FILE = 'utility_field_data.csv'

def load_data():
    if os.path.exists(DATA_FILE):
        return pd.read_csv(DATA_FILE)
    else:
        return pd.DataFrame(columns=["Date", "Pole Number", "Location", "Permit Status", "NESC Issues", "Image Name"])

def save_data(new_entry):
    df = load_data()
    new_df = pd.DataFrame([new_entry])
    df = pd.concat([df, new_df], ignore_index=True)
    df.to_csv(DATA_FILE, index=False)
    return df

# --- APP INTERFACE ---
st.set_page_config(page_title="Utility Field Master", layout="wide")

st.title("âš¡ Utility Field Master")
st.markdown("Professional Tracking & Compliance Tool")

# 1. SIDEBAR: Compliance Tools
st.sidebar.header("ğŸ› ï¸ Compliance Toolkit")
tool_mode = st.sidebar.selectbox("Select Tool", ["NESC Compliance Check", "Permit Tracker"])

if tool_mode == "NESC Compliance Check":
    st.sidebar.subheader("NESC Rule Validator")
    rule = st.sidebar.selectbox("Rule Type", ["Comm Worker Safety Zone (40in)", "Vertical Clearance (15.5ft)"])
    
    if rule == "Comm Worker Safety Zone (40in)":
        measured = st.sidebar.number_input("Measured Gap (inches)", 0)
        if measured > 0:
            if measured < 40:
                st.sidebar.error(f"âŒ VIOLATION: {measured}in is unsafe.")
            else:
                st.sidebar.success("âœ… COMPLIANT")

# 2. MAIN AREA
col1, col2 = st.columns([1, 2])

with col1:
    st.subheader("ğŸ“¸ Field Capture")
    uploaded_file = st.file_uploader("Upload Pole Photo", type=['jpg', 'png', 'jpeg'])
    
    extracted_text = ""
    if uploaded_file is not None:
        image = Image.open(uploaded_file)
        st.image(image, caption='Field Image', use_container_width=True)
        
        if st.button("ğŸ” OCR Scan (Read Text)"):
            try:
                # Basic OCR attempt
                extracted_text = pytesseract.image_to_string(image)
                st.info(f"Scanned Text: {extracted_text}")
            except Exception as e:
                st.error("OCR Engine not found. (Requires setup on server)")

with col2:
    st.subheader("ğŸ“ Data Entry")
    with st.form("entry_form"):
        pole_num = st.text_input("Pole ID / Tag Number", value=extracted_text.strip())
        location = st.text_input("GPS / Address Location")
        status = st.selectbox("Permit Status", ["Active", "Pending", "Closed", "Violation Found"])
        
        issues = st.multiselect("Flag NESC Issues", 
                                ["Clearance Violation", 
                                 "Broken Ground Wire", 
                                 "Climbing Space Obstructed", 
                                 "Vegetation Encroachment"])
        
        notes = st.text_area("Field Notes")
        
        submitted = st.form_submit_button("âœ… Save Entry")
        
        if submitted:
            new_entry = {
                "Date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "Pole Number": pole_num,
                "Location": location,
                "Permit Status": status,
                "NESC Issues": ", ".join(issues),
                "Image Name": uploaded_file.name if uploaded_file else "No Image"
            }
            save_data(new_entry)
            st.success("Entry Saved Successfully!")

# 3. DATA PREVIEW
st.divider()
st.subheader("ğŸ“‚ Project Data Sheet")
if os.path.exists(DATA_FILE):
    st.dataframe(load_data(), use_container_width=True)
    
    # Allow user to download the CSV
    with open(DATA_FILE, "rb") as f:
        st.download_button("Download CSV Report", f, file_name="field_report.csv")